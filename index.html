<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZipFlat | Professional Zip Organizer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            width: 100%;
            background: var(--bg-card);
            padding: 1.5rem 0;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* --- Container --- */
        .container {
            width: 90%;
            max-width: 1000px;
            padding-bottom: 80px; /* Space for footer */
        }

        /* --- Upload Zone --- */
        .upload-zone {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 4rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .upload-zone svg {
            width: 64px;
            height: 64px;
            color: var(--primary);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .upload-zone:hover svg {
            transform: scale(1.1);
        }

        .upload-zone h2 {
            font-size: 1.25rem;
            margin: 0 0 0.5rem 0;
        }

        .upload-zone p {
            color: var(--text-sub);
            margin: 0;
        }

        input[type="file"] { display: none; }

        /* --- Loader --- */
        .loader-container {
            display: none; /* Hidden by default */
            margin-top: 2rem;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary-light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }

        /* --- Dashboard / Results --- */
        #dashboard {
            display: none; /* Hidden by default */
            margin-top: 2rem;
            animation: slideUp 0.5s ease-out;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .dashboard-header h3 {
            font-size: 1.25rem;
            margin: 0;
        }

        .stats-badge {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* --- Category Grid --- */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .category-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        .card-header {
            padding: 1rem;
            background: #f1f5f9;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header strong {
            text-transform: uppercase;
            color: var(--text-main);
            font-size: 0.9rem;
        }

        .card-body {
            padding: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
        }

        /* Custom Scrollbar */
        .card-body::-webkit-scrollbar { width: 6px; }
        .card-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: var(--bg-body);
        }

        .file-item label {
            margin-left: 10px;
            font-size: 0.9rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            width: 100%;
        }

        /* Custom Checkbox */
        input[type="checkbox"] {
            accent-color: var(--primary);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* --- Footer / Sticky Action Bar --- */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            padding: 1rem;
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }

        .action-bar.visible {
            transform: translateY(0);
        }

        .btn-download {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-download:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-download:disabled {
            background: var(--text-sub);
            cursor: not-allowed;
            transform: none;
        }

        .summary-text {
            font-weight: 500;
            color: var(--text-sub);
        }

        /* --- Animations --- */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <header>
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
            ZipFlat
        </h1>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <h2>Upload your ZIP file</h2>
            <p>Drag & drop or click to browse</p>
            <input type="file" id="fileInput" accept=".zip">
        </div>

        <!-- Processing Loader -->
        <div class="loader-container" id="loader">
            <div class="spinner"></div>
            <p>Processing files & flattening folders...</p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard">
            <div class="dashboard-header">
                <div>
                    <h3>File Categorization</h3>
                    <p style="color:var(--text-sub); font-size: 0.9rem; margin-top:5px;">
                        Uncheck files you want to remove (Cut) from the final Zip.
                    </p>
                </div>
                <div class="stats-badge" id="totalFilesBadge">0 Files Found</div>
            </div>

            <div class="category-grid" id="categoryContainer">
                <!-- Categories will be injected here via JS -->
            </div>
        </div>
    </div>

    <!-- Sticky Bottom Bar -->
    <div class="action-bar" id="actionBar">
        <span class="summary-text" id="selectionSummary">0 files selected</span>
        <button class="btn-download" id="downloadBtn" onclick="processDownload()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Download Flattened ZIP
        </button>
    </div>

    <script>
        // Global State
        let originalZipData = {};
        let flattenedFiles = [];
        
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const loader = document.getElementById('loader');
        const dashboard = document.getElementById('dashboard');
        const categoryContainer = document.getElementById('categoryContainer');
        const actionBar = document.getElementById('actionBar');
        const downloadBtn = document.getElementById('downloadBtn');

        // Drag & Drop Handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if(file && file.name.endsWith('.zip')) {
                handleFileUpload(file);
            } else {
                alert("Please upload a valid .zip file");
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFileUpload(e.target.files[0]);
        });

        // Core Logic
        async function handleFileUpload(file) {
            // UI Reset
            dropZone.style.display = 'none';
            loader.style.display = 'block';
            dashboard.style.display = 'none';
            actionBar.classList.remove('visible');

            try {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                
                originalZipData = content.files;
                flattenedFiles = [];
                const nameTracker = new Map(); // To detect duplicates

                // Flattening Algorithm
                for (let filepath in originalZipData) {
                    const fileObj = originalZipData[filepath];
                    
                    if (fileObj.dir) continue; // Skip folders

                    // Logic to extract just filename
                    let baseName = filepath.split('/').pop();
                    
                    // Rename logic for duplicates
                    if (nameTracker.has(baseName)) {
                        let count = nameTracker.get(baseName);
                        nameTracker.set(baseName, count + 1);
                        
                        // Insert (n) before extension
                        const lastDot = baseName.lastIndexOf('.');
                        if (lastDot !== -1) {
                            baseName = baseName.substring(0, lastDot) + `(${count})` + baseName.substring(lastDot);
                        } else {
                            baseName = baseName + `(${count})`;
                        }
                    } else {
                        nameTracker.set(baseName, 1);
                    }

                    // Determine Category/Extension
                    let ext = baseName.split('.').pop().toLowerCase();
                    if (baseName.indexOf('.') === -1) ext = 'unknown';

                    flattenedFiles.push({
                        originalPath: filepath,
                        newName: baseName,
                        extension: ext,
                        id: Math.random().toString(36).substr(2, 9)
                    });
                }

                renderDashboard();
                loader.style.display = 'none';
                dashboard.style.display = 'block';
                actionBar.classList.add('visible');

            } catch (err) {
                console.error(err);
                alert("Error reading ZIP file. Please try again.");
                loader.style.display = 'none';
                dropZone.style.display = 'block';
            }
        }

        function renderDashboard() {
            categoryContainer.innerHTML = '';
            
            // Group files by extension
            const groups = flattenedFiles.reduce((acc, file) => {
                acc[file.extension] = acc[file.extension] || [];
                acc[file.extension].push(file);
                return acc;
            }, {});

            document.getElementById('totalFilesBadge').innerText = `${flattenedFiles.length} Total Files`;

            // Sort extensions alphabetically
            Object.keys(groups).sort().forEach(ext => {
                const files = groups[ext];
                const card = document.createElement('div');
                card.className = 'category-card';

                // Header HTML
                card.innerHTML = `
                    <div class="card-header">
                        <strong>.${ext}</strong>
                        <div style="font-size:0.8rem; color:var(--text-sub);">
                            <input type="checkbox" checked onchange="toggleGroup(this, '${ext}')"> Select All
                        </div>
                    </div>
                `;

                // Body HTML (File List)
                const body = document.createElement('div');
                body.className = 'card-body';
                
                files.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    item.innerHTML = `
                        <input type="checkbox" class="file-chk group-${ext}" 
                               id="${file.id}" checked 
                               data-path="${file.originalPath}" 
                               data-newname="${file.newName}"
                               onchange="updateSummary()">
                        <label for="${file.id}" title="${file.newName}">${file.newName}</label>
                    `;
                    body.appendChild(item);
                });

                card.appendChild(body);
                categoryContainer.appendChild(card);
            });

            updateSummary();
        }

        function toggleGroup(masterCheckbox, ext) {
            const checkboxes = document.querySelectorAll(`.group-${ext}`);
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
            updateSummary();
        }

        function updateSummary() {
            const total = document.querySelectorAll('.file-chk').length;
            const selected = document.querySelectorAll('.file-chk:checked').length;
            
            const summaryText = document.getElementById('selectionSummary');
            summaryText.innerText = `${selected} of ${total} files selected`;

            // Disable button if nothing selected
            downloadBtn.disabled = selected === 0;
            if(selected === 0) {
                summaryText.style.color = 'var(--danger)';
            } else {
                summaryText.style.color = 'var(--text-sub)';
            }
        }

        async function processDownload() {
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = `<div class="spinner" style="width:16px; height:16px; border-width:2px; margin:0;"></div> Generating...`;

            try {
                const newZip = new JSZip();
                const selectedCheckboxes = document.querySelectorAll('.file-chk:checked');

                for (let cb of selectedCheckboxes) {
                    const originalPath = cb.getAttribute('data-path');
                    const newName = cb.getAttribute('data-newname');
                    
                    // Fetch blob from original zip
                    const fileData = await originalZipData[originalPath].async("blob");
                    
                    // Add to root of new zip
                    newZip.file(newName, fileData);
                }

                // Generate file
                const content = await newZip.generateAsync({type: "blob"});
                saveAs(content, "flattened_files.zip");

                // Reset button
                downloadBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Download Again
                `;
                downloadBtn.disabled = false;

            } catch (error) {
                console.error(error);
                alert("An error occurred during zip generation.");
                downloadBtn.innerText = "Try Again";
                downloadBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
