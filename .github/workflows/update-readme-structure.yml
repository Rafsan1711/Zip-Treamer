name: Update README Structure

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'  # Infinite loop avoid korte

jobs:
  update-structure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if any file was added or deleted
        id: check
        run: |
          # Last commit e kono file add (A) ba delete (D) hoyeche kina check koro
          CHANGED=$(git diff --name-status HEAD~1 HEAD | awk '$1 == "A" || $1 == "D"' | wc -l)

          if [ "$CHANGED" -gt 0 ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "File add/delete detected ($CHANGED file(s)). Proceeding..."
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No file add/delete found. Skipping."
          fi

      - name: Generate directory tree
        id: tree
        if: steps.check.outputs.has_changes == 'true'
        run: |
          sudo apt-get install -y tree

          TREE_OUTPUT=$(tree -a \
            --noreport \
            -I '.git|node_modules|__pycache__|*.pyc|.DS_Store|*.egg-info|.env|venv|.venv' \
            .)

          {
            echo "tree<<EOF"
            echo "$TREE_OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Update README.md project structure
        if: steps.check.outputs.has_changes == 'true'
        run: |
          python3 << 'PYEOF'
          import re, os

          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()

          tree_output = os.environ["TREE_OUTPUT"]

          new_block = f"## Repository Structure\n\n```\n{tree_output}\n```\n"

          pattern = r"## Repository Structure\s*\n[\s\S]*?(?=\n## |\Z)"
          new_content, count = re.subn(pattern, new_block, content)

          if count == 0:
              print("WARNING: 'Repository Structure' section not found in README.md")
              exit(1)

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(new_content)

          print("README.md updated successfully.")
          PYEOF
        env:
          TREE_OUTPUT: ${{ steps.tree.outputs.tree }}

      - name: Commit and push if changed
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: auto-update project structure in README [skip ci]"
            git push
          fi
